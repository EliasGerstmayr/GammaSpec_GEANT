source = './especs/csvfiles/';
date = '20180410';
run = '001';
path = [source date 'r' run '/'];

csvlist = dir([path '*.dat']);
csvlist = {csvlist.name}';

particles_per_run = 1e5;

executecommand = strings(length(csvlist),1);

for n = 1:length(csvlist)
    nameroot = csvlist{n}(1:16);
    macfname = ['./scripts_arbBrems/' date 'r' run '/ArbBrems_' nameroot '.mac'];
    outputfname = ['ArbBrems_' nameroot];

    inputdeck= ['/run/numberOfThreads 1' char(10),...
                '/run/initialize' char(10), ...
                '/vis/open HepRepFile' char(10), ...
                '/vis/drawVolume' char(10), ...
                '/vis/scene/add/trajectories smooth' char(10), ...
                '/vis/scene/endOfEventAction accumulate 10' char(10), ...
                '/gps/particle e-' char(10), ...
                '/gps/pos/centre 0 0 42.5 cm' char(10), ...
                '/gps/ang/type beam1d' char(10), ...
                '/gps/ang/sigma_r 0.02 deg' char(10), ...
                '/gps/pos/type Beam' char(10), ...
                '/gps/pos/shape Circle' char(10), ...
                '/gps/pos/sigma_r 0.425 um' char(10), ...
                '/gps/ene/type Arb' char(10), ...
                '/gps/hist/type energy' char(10), ...
                '/gps/hist/file ' path csvlist{n} char(10), ...
                '/gps/hist/inter Lin' char(10), ...
                '/B1/histo/setOutputFile ' outputfname char(10), ...
                '/run/beamOn ' num2str(particles_per_run) char(10),...
                '/vis/viewer/flush'];

    fid = fopen(macfname, 'w');
    fprintf(fid, inputdeck);
    fclose(fid);
    executecommand{n} =  ['./QED ' macfname ';'];

end

executecommand_file = ['buffer_arbBrems_' date 'r' run '.txt'];
fid = fopen(executecommand_file, 'w');
fprintf(fid,'%s\n', executecommand);
fclose(fid);
